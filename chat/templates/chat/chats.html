{% extends "chat/Base.html" %}
{% load static %}

{% block  content %}

<div style="margin-top: 12px">
    <h3><span> שיחה עם </span>{{friend.name}}</h3>
</div>
<div class="messages" id="board">
    {% block message %}
    {% endblock %}
</div>
<div class="message-pane">
    <form method="post" class="form-group" id="chat-box">
        {% csrf_token %}
        <div class="input-group">
            <div class="input-group-prepend">
                <input type="text" placeholder="Send a message..." name="message" id="msg_field">
                <button type="submit" name="send" class="btn btn-success send-button" id="send_btn"><i
                        class="fas fa-paper-plane"></i> Send</button>
            </div>
        </div>
    </form>
</div>

<script>
    const messageBody = document.querySelector('.messages');
    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;

    sender_id = "{{ friend.id }}";
    receiver_id = "{{ curr_user.id }}";

    function scrolltoend() {
        $('#board').stop().animate({
            scrollTop: $('#board')[0].scrollHeight
        }, 800);
    }

    // Template for messages
    const text_box = '<div class="d-flex align-items-center mb-4 message-container justify-content-end">' +
                     '<div class="message-text">' +
                     '<div class="card card-text p-2 px-3 m-1">{content}</div>' +
                     '<div class="small time-left">{time}</div>' +
                     '</div>' +
                     '<div class="avatar">' +
                     '<img src="{% static curr_user.avatar %}" class="rounded-circle">' +
                     '</div>' +
                     '</div>';


    // For sending messages
    $(function () {
        $('#chat-box').on('submit', function (event) {
            event.preventDefault();
            var message = $('#msg_field');
            send('{{ curr_user.username }}', '{{ friend.username }}', message.val());
            message.val('');
        });
    })

    function send(sender, receiver, message){
        $.post('/api/messages', '{"sender": "' + sender + '", "receiver": "' +
                receiver + '","content": "' + message + '" }', function (data) {
            var field = text_box.replace('{content}', message);
            var today = new Date();
            var time = today.getHours() + ":" + today.getMinutes();
            field = field.replace('{time}', time);
            $('#board').append(field);
            scrolltoend();
        });
    }


</script>

{% endblock %}
